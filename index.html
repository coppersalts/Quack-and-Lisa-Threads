<!DOCTYPE html>
<html>
	<head>
		<title>Quack and Lisa Threads</title>
		<meta charset="utf-8"></meta>
		<script>
			let threads = {};
			let pageFilenames = [];
			let selectedThread = '';
			window.addEventListener('load', async () => {
				// threads = await (await fetch('threads.json')).json();
				pageFilenames = await (await fetch('pages.json')).json();
				const savedThreads = window.localStorage.getItem('threads');
				if (savedThreads) {
					threads = JSON.parse(savedThreads);
				}
				updatePage();
			});

			window.addEventListener('hashchange', updatePage);

			function updatePage() {
				if (window.location.hash == '') {
					createMainPage();
				} else {
					selectedThread = decodeURI(window.location.hash).slice(1);
					if (Object.keys(threads).includes(selectedThread)) {
						createThreadPage();
					} else {
						document.body.innerHTML = "There exists no thread by the specified name in your current threads list.";
					}
				}
			}

			function loadThreads() {
				const textarea = document.querySelector('#threads-data');
				if (textarea) {
					threads = JSON.parse(textarea.value);
					window.localStorage.setItem('threads', JSON.stringify(threads));
					createMainPage();
				}
			}

			function createMainPage() {
				let newContent = '';
				let existingTextarea = document.querySelector('#threads-data');
				if (existingTextarea) {
					newContent += existingTextarea.outerHTML;
					var oldTextareaValue = existingTextarea.value;
					existingTextarea = true;
				} else {
					newContent += '<textarea id="threads-data"></textarea>';
				}
				newContent += '<br><button onClick="loadThreads()">Load Threads</button><ul>';
				const threadNames = Object.keys(threads);
				for (let i = 0; i < threadNames.length; i++) {
					newContent += `<li><a href="#${threadNames[i]}">${threadNames[i]}</a> (${threads[threadNames[i]].length} pages)</li>`;
				}
				newContent += '</ul>';
				document.body.innerHTML = newContent;
				if (existingTextarea) {
					document.querySelector('#threads-data').value = oldTextareaValue;
				}
			}

			function createThreadPage() {
				let newContent = '<a href="#">Home</a><br>';
				for (let i = 0; i < threads[selectedThread].length; i++) {
					if (i > 0) newContent += '<hr>';
					const pageNumber = threads[selectedThread][i];
					if (pageNumber - 1 < pageFilenames.length) {
						newContent += `<div class="page"><a href="https://quackandlisa.the-comic.org/comics/${pageNumber}/#content-start"><img loading="lazy" src="${pageFilenames[pageNumber-1]}" height="1660" width="550"></div>`;
					} else {
						newContent += `<div class="page"><a href="https://quackandlisa.the-comic.org/comics/${pageNumber}/#content-start">(page ${pageNumber})</div>`;
					}
				}
				document.body.innerHTML = newContent;
			}
		</script>
<style>
.page {
	margin: auto;
	text-align: center;
	display: block;
	/*min-height: min(1660px, 100vh);*/
}
.page img {
	height: auto;
	width: auto;
	max-width: 100%;
}
</style>
	</head>
	<body>
	</body>
</html>
